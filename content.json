{"pages":[{"title":"about~~~~","text":"","link":"/about/about.html"},{"title":"categories","text":"","link":"/categories/index.html"},{"title":"tags","text":"","link":"/tags/index.html"}],"posts":[{"title":"useCallbackä½¿ç”¨åœºæ™¯è¯´æ˜å’Œä¸¾æ —","text":"ä½¿ç”¨ react hooks æ—¶, çˆ¶ç»„ä»¶å‘å­ç»„ä»¶ä¼ é€’å‡½æ•° æˆ– åœ¨ useEffect ä¸­ä½¿ç”¨å¤–éƒ¨å‡½æ•°, å¦‚æœä¸åšä»»ä½•å¤„ç†ä¼šå‡ºç° ç»„ä»¶é‡å¤æ¸²æŸ“ æˆ– useEffect ä¸­çš„é€»è¾‘è¢«ä¸åœè§¦å‘çš„æƒ…å†µ, ä¸€èˆ¬è¿™ä¸ªæ—¶å€™ react-hooks çš„ lint ä¹Ÿä¼šæŠ¥é”™ã€‚è¿™ç§æƒ…å†µå¯ä»¥ä½¿ç”¨ useCallback æ¥å°†åŸå‡½æ•°åŒ…è£…ä¸€å±‚å†ä¼ åˆ°éœ€è¦ç”¨çš„åœ°æ–¹, é¿å…å¼‚å¸¸æƒ…å†µã€‚ æœ¬æ–‡ä»‹ç»äº†ä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨ useCallback, useCallback å¦‚ä½•å’Œ React.memo() é…åˆä½¿ç”¨, å¹¶é™„ä¸Šç¤ºä¾‹ä»£ç åŠgifæˆªå±, æ–¹ä¾¿æ›´ç›´è§‚çš„ç†è§£ã€‚ åŸºæœ¬ç”¨æ³•æŠŠä½ è¦çš„å‡½æ•°ç”¨ useCallback åŒ…ä¸€å±‚, å®šä¹‰å¥½åªæœ‰ä»€ä¹ˆå‚æ•°å˜åŒ–æ—¶, è¿™ä¸ªè¢«åŒ…è¿‡çš„å‡½æ•°æ‰éœ€è¦æ›´æ–° 123456789const yourfunc = useCallback( () =&gt; { // ä½ è¦å†™çš„å‡½æ•°é€»è¾‘ }, [ // åœ¨æ•°ç»„é‡Œå®šä¹‰ä»€ä¹ˆå‚æ•°æ”¹å˜æ—¶æ‰éœ€è¦æ›´æ–° yourfunc, // åªè¦è¿™é‡Œçš„ä¾èµ–çš„å‚æ•°æ²¡æœ‰å˜å¯¹äºä»»ä½•ä½¿ç”¨å®ƒçš„ä¸€æ–¹å®ƒéƒ½æ²¡æœ‰å˜ ]) ä½¿ç”¨åœºæ™¯1.çˆ¶ç»„ä»¶å‘å­ç»„ä»¶ä¼ é€’å‡½æ•°æ—¶, é˜»æ­¢ä¼ é€’çš„å‡½æ•°åœ¨æ¯æ¬¡ render æ—¶é‡æ–°åˆ›å»ºï¼Œä»è€Œé€ æˆå­ç»„ä»¶ rerenderã€‚éœ€è¦é…åˆ React.memo() ä¸€èµ·ä½¿ç”¨ã€‚ 2.åœ¨ useEffectï¼ˆï¼‰ ä¸­ä½¿ç”¨å¤–éƒ¨åˆ›å»ºçš„å‡½æ•°, ä½†ä¸å¸Œæœ›è¿™ä¸ªå‡½æ•°ä¸€ç›´å˜åŒ–, å¯¼è‡´ useEffect è¢«é‡å¤è§¦å‘ã€‚ æ —å­ğŸŒ°1.çˆ¶ç»„ä»¶ä¼ é€’å‡½æ•°ç»™å­ç»„ä»¶ ä½¿ç”¨ useCallback å‰ï¼Œçˆ¶ç»„ä»¶ç›´æ¥ä¼ å‡½æ•°ç»™å­ç»„ä»¶çš„æ–¹å¼ã€‚æ¯æ¬¡ app render æ—¶, ä¼ é€’çš„å‡½æ•° () =&gt; setCount(count + 1) éƒ½ä¼šé‡æ–°åˆ›å»ºä¸€æ¬¡ã€‚æ¯æ¬¡ç‚¹å‡» hello æŒ‰é’®ï¼Œéƒ½ä¼šè¿›è¡Œ renderã€‚ ä¸Šå›¾ log æ˜¯æ‰“åœ¨å­ç»„ä»¶ &lt;Hello \u0010/&gt; ä¸­çš„, ä»logå¯ä»¥çœ‹åˆ°, æ¯æ¬¡ç‚¹å‡»æŒ‰é’®éƒ½ä¼šé€ æˆå­ç»„ä»¶ rerenderã€‚ ä½¿ç”¨ useCallback å‰çš„çˆ¶ç»„ä»¶ 1234567891011121314import React, { useState } from 'react'import { Hello } from './hello'export default function Counter() { const [count, setCount] = useState(0) // éœ€è¦æ³¨æ„, æ¯æ¬¡ render ä¼ é€’çš„å‡½æ•°éƒ½ä¼šé‡æ–°ç”Ÿæˆ // ä¹Ÿå°±æ˜¯ä¸‹é¢çš„ () =&gt; setCount(count + 1) return ( &lt;div&gt; &lt;Hello increment={() =&gt; setCount(count + 1)} /&gt; &lt;div&gt;count: {count}&lt;/div&gt; &lt;/div&gt; )} å­ç»„ä»¶å­ç»„ä»¶ä¸­ React.memo() çš„ä½œç”¨ç±»ä¼¼äº class ç»„ä»¶ä¸­çš„ shouldComponentUpdate, ä¼šå¯¹ç»„ä»¶æ¥å—åˆ°çš„ propsè¿›è¡Œæµ…æ¯”è¾ƒ, å¦‚æœ props æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œç»„ä»¶å°±ä¸ä¼š rerender. å¦‚æœè¿™é‡ŒæŠŠ React.memo() å»æ‰, é‚£å³ä½¿çˆ¶ç»„ä»¶ä½¿ç”¨ useCallback æ”¹å†™ã€‚å­ç»„ä»¶ è¿˜æ˜¯ä¼š rerenderã€‚ 1234567891011import React, { useRef } from 'react'// ä½¿ç”¨ React.memo ä½¿ç»„ä»¶ä»…åœ¨ props æ›´æ–°æ—¶æ›´æ–°// æœªä½¿ç”¨ useCallback æ—¶, ç”±äºæ¯æ¬¡ä¼ é€’è¿‡æ¥çš„ increment æ¥åˆ°çš„å‡½æ•°éƒ½ä¼šæ›´æ–°, å­ç»„ä»¶æ¯æ¬¡éƒ½ä¼šrerenderexport const Hello = React.memo(({ increment }) =&gt; { // ä¸‹é¢ä¸¤å¥ç”¨æ¥æŸ¥çœ‹ç»„ä»¶æ›´æ–°çš„æ¬¡æ•° const renderCount = useRef(0) console.log('render count:', renderCount.current++) return &lt;button onClick={increment}&gt;hello&lt;/button&gt;}) ä½¿ç”¨ useCallback æ”¹å†™çˆ¶ç»„ä»¶å, æ¯æ¬¡æ›´æ–°æ•°æ®ç»„ä»¶ä¸å†é‡æ–°æ¸²æŸ“, å¦‚å›¾ ä½¿ç”¨ useCallback æ”¹å†™åŸçˆ¶ç»„ä»¶, å­ç»„ä»¶ä¸éœ€è¦ä¿®æ”¹1234567891011121314151617181920import React, { useState, useCallback } from 'react'import { Hello } from './hello'export default function Counter() { const [count, setCount] = useState(0) // useCallback ä»…å°† setCount ä½œä¸ºä¾èµ–, åªè¦ setCount ä¸æ”¹å˜, // increment å‡½æ•°å°±ä¸ä¼šæ”¹å˜ // ç›¸åº”çš„å­ç»„ä»¶æ¥å—åˆ°çš„ props æ²¡æ”¹å˜, å°±ä¸ä¼š rerender const increment = useCallback(() =&gt; { setCount(prevCount =&gt; prevCount + 1) }, [setCount]) return ( &lt;div&gt; &lt;Hello increment={increment} /&gt; &lt;div&gt;count: {count}&lt;/div&gt; &lt;/div&gt; )} ä½¿ç”¨ map æ¸²æŸ“å¤šä¸ªå­ç»„ä»¶å¹¶ä¼ é€’å‡½æ•°ç»™å®ƒä»¬ ä¸‹é¢çš„è®¡æ•°å™¨å°†ä¸€ä¸ªæ•°å­—æ„æˆçš„æ•°ç»„æ¸²æŸ“æˆå¤šä¸ªæŒ‰é’®, ç‚¹å‡»æŒ‰é’®ç»™ count å¢åŠ ç›¸åº”çš„å€¼ã€‚ä¸ä¸Šé¢çš„ä¾‹å­ä¸åŒçš„æ˜¯, è¿™é‡Œçš„ increment éœ€è¦ä¼ å…¥å¯¹åº”çš„æ•°å­—, è¿›è¡Œç›¸åº”è®¡æ•°ã€‚æ”¾ä¸Šè¿™ä¸ªä¾‹å­æ˜¯ä¸ºäº†è¯´æ˜, å¦‚æœ å­ç»„ä»¶è¦æ‰§è¡Œçš„å‡½æ•° å’Œ å‡½æ•°è¦ç”¨åˆ°çš„å‚æ•° éƒ½æ˜¯çˆ¶ç»„ä»¶æä¾›çš„, æœ€å¥½æŠŠäºŒè€…éƒ½ä¼ é€’ç»™å­ç»„ä»¶åœ¨å­ç»„ä»¶æ‰§è¡Œã€‚ æ”¹å†™å‰ç‚¹å‡»è®¡æ•°æˆªå›¾ ä¼šé€ æˆ rerender çš„çˆ¶ç»„ä»¶å‡½æ•°ä¼ é€’æ–¹å¼ 12345678910111213141516171819202122232425262728import React, { useState, useCallback } from 'react'import { Num } from './numbers'export default function Counter() { const [count, setCount] = useState(0) const nums = [3, 33, 333] const increment = useCallback(n =&gt; { setCount(prevCount =&gt; prevCount + n) }, [setCount]) // ä¼ é€’ () =&gt; increment(n), è€Œä¸æ˜¯ç›´æ¥ä¼ é€’ increment // ä»ç„¶ä¼šé€ æˆæ¯æ¬¡ render ç”Ÿæˆä¸€ä¸ªæ–°çš„å‡½æ•° return ( &lt;div&gt; { nums.map(n =&gt; &lt;Num onClick={() =&gt; increment(n)} n={n} key={n} /&gt; ) } &lt;div&gt;count: {count}&lt;/div&gt; &lt;/div&gt; )} ç›¸åº”çš„å­ç»„ä»¶ç›´æ¥è°ƒç”¨ onClick 123456789import React, { useRef } from 'react'export const Num = React.memo(({ onClick, n }) =&gt; { // ä»¥ä¸‹ä¸¤å¥ç”¨æ¥æŸ¥çœ‹ç»„ä»¶æ›´æ–°çš„æ¬¡æ•° const renderCount = useRef(0) console.log('render count:', renderCount.current++) return &lt;button onClick={onClick}&gt;{n}&lt;/button&gt;}) æ”¹å†™åç‚¹å‡»è®¡æ•°æˆªå›¾ æ”¹å†™åçš„ çˆ¶ç»„ä»¶1234567891011121314151617181920212223242526import React, { useState, useCallback } from 'react'import { Num } from './numbers'export default function Counter() { const [count, setCount] = useState(0) const nums = [3, 33, 333] const increment = useCallback(n =&gt; { setCount(prevCount =&gt; prevCount + n) }, [setCount]) return ( &lt;div&gt; { nums.map(n =&gt; &lt;Num increment={increment} n={n} key={n} /&gt; ) } &lt;div&gt;count: {count}&lt;/div&gt; &lt;/div&gt; )} æ”¹å†™åçš„å­ç»„ä»¶ 1234567export const Num = React.memo(({ increment, n }) =&gt; { // ä»¥ä¸‹ä¸¤å¥ç”¨æ¥æŸ¥çœ‹ç»„ä»¶æ›´æ–°çš„æ¬¡æ•° const renderCount = useRef(0) console.log('render count:', renderCount.current++) return &lt;button onClick={() =&gt; {increment(n)}}&gt;{n}&lt;/button&gt;})","link":"/2020/01/13/useCallbackä½¿ç”¨åœºæ™¯/"},{"title":"å¼‚æ­¥å’ŒPromiseæ‰§è¡Œè¿‡ç¨‹å›¾è§£","text":"ä¸ºä»€ä¹ˆä¼šæœ‰å¼‚æ­¥JavaScript æ˜¯å•çº¿ç¨‹æŒ‰ç…§ä»£ç é¡ºåºä¸€è¡Œè¡Œæ‰§è¡Œçš„, æŒ‰ç†è¯´å¸¸è§„çš„ä»£ç åº”è¯¥æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼šé‡åˆ°å‡½æ•°è°ƒç”¨å½¢å¦‚ functionName(params) æ—¶, å°†å‡½æ•°æ”¾å…¥ Call Stack è°ƒç”¨æ ˆä¸­æ‰§è¡Œ, æ‰§è¡Œå®Œåä»è°ƒç”¨æ ˆä¸­ pop å‡ºå¹¶è¿”å›ç»“æœ, å†ç»§ç»­æ‰§è¡Œä¸‹ä¸€è¡Œä»£ç ã€‚ ä½†å¹³æ—¶æˆ‘ä»¬ç”¨ JavaScript æ‰€å†™çš„å¾ˆå¤šåŠŸèƒ½å¹¶ä¸æ˜¯ JavaScript, è€Œæ˜¯ JS è°ƒç”¨å¤–éƒ¨æ¥å£æ¥å®ç°çš„, å¦‚ Web Browser APIsï¼ˆè€Œæµè§ˆå™¨æ˜¯ç”¨ c++ å®ç°çš„ç›¸åº”åŠŸèƒ½ï¼‰ã€‚è¿™äº›åŠŸèƒ½çš„æ‰§è¡Œå¹¶ä¸æ˜¯åœ¨ JS çš„å‡½æ•°è°ƒç”¨æ ˆä¸­, è€Œæ˜¯åœ¨æµè§ˆå™¨ä¸­, å¹¶ä¸ä¼šé˜»å¡ JS ç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç , è¿™å°±å½¢æˆäº†å¼‚æ­¥ã€‚ åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹, æˆ‘ä»¬åœ¨æ‰§è¡Œè¯¸å¦‚æ•°æ®è¯·æ±‚è¿™ç±»æ¯”è¾ƒè€—æ—¶çš„æ“ä½œæ—¶, å’Œè¿œç¨‹å»ºç«‹è¿æ¥å¹¶å–å›æ•°æ®çš„æ´»å®é™…æ˜¯æµè§ˆå™¨åœ¨åš, è€Œä¸æ˜¯ JS, æ‰€ä»¥ä»»åŠ¡å¹¶ä¸ä¼šæ”¾åˆ° JS çš„è°ƒç”¨æ ˆä¸­, JS ä»ç„¶ä¸å—å½±å“ç»§ç»­å¾€ä¸‹æ‰§è¡Œ, ä»è€Œä¸ä¼šé€ æˆç”¨æˆ·åœ¨ç­‰å¾…æ•°æ®è¿”å›æœŸé—´é¡µé¢å®Œå…¨ä¸èƒ½æ“ä½œçš„æƒ…å†µã€‚ å¼‚æ­¥çš„å«ä¹‰å¼‚æ­¥ä»£ç ä¸æŒ‰ç…§çœ‹åˆ°çš„é¡ºåºæ‰§è¡Œ, å½“å¼‚æ­¥æ‰§è¡Œçš„å‡½æ•°è¿”å›ç»™ JS æ—¶, JS æ‰å¤„ç†å®ƒã€‚ åŒºåˆ†æµè§ˆå™¨å’Œ JS çš„ä¸–ç•Œå¹³æ—¶æˆ‘ä»¬ä½¿ç”¨ JS åšçš„å¾ˆå¤§ä¸€éƒ¨åˆ†éƒ½ä¸æ˜¯ JS çš„åŠŸèƒ½, è€Œæ˜¯æµè§ˆå™¨çš„åŠŸèƒ½ã€‚ä¾‹å¦‚, setTimeout æ˜¯æµè§ˆå™¨çš„å®šæ—¶å™¨åŠŸèƒ½, â€œsetTimeoutâ€ æ˜¯ JS å’Œæµè§ˆå™¨äº¤äº’çš„ APIã€‚JS åŒæ ·æ²¡æœ‰å‘é€ç½‘ç»œè¯·æ±‚çš„èƒ½åŠ›, è¿™ä¹Ÿæ˜¯æµè§ˆå™¨æä¾›çš„åŠŸèƒ½ã€‚ ä¸‹é¢è¿™äº›å¸¸ç”¨åŠŸèƒ½å®¹æ˜“è¢«è¯¯è®¤ä¸ºæ˜¯ JS çš„åŠŸèƒ½, ä½†å®é™…ä¸Šæ˜¯æµè§ˆå™¨çš„åŠŸèƒ½ï¼ŒJS åªæ˜¯è°ƒç”¨äº†æµè§ˆå™¨çš„ APIã€‚ console - consolesocketsNetwork request - xhrã€fetchHTML DOM - DocumentTimer - setTimeoutlocalStorage - localStorageIndexedDB PS. è™½ç„¶è¿™äº›åŠŸèƒ½å¾ˆå¸¸ç”¨, ä½†çŸ¥é“äº†è¿™ä»¶äº‹, æˆ‘æ‰æ˜ç™½äº†ä¸ºä»€ä¹ˆè¯´ node.js æ˜¯å¯ä»¥è„±ç¦»æµè§ˆå™¨ç¯å¢ƒæ‰§è¡Œçš„è¯­è¨€ã€‚ Callback Queue å’Œ event loopCallback Queueç¤ºä¾‹å’Œè¯´æ˜1å…ˆé€šè¿‡ä¸‹é¢ä¸€æ®µå®šæ—¶å™¨ä»£ç æ¥è¯´æ˜ä¸€ä¸‹å¼‚æ­¥æ‰§è¡Œçš„è¿‡ç¨‹ã€‚ 12345function printHello(){ console.log(\"Hello\") }setTimeout(printHello,1000)console.log(\"Me first!\") ç¬¬ä¸€è¡Œåœ¨ global memory ä¸­å®šä¹‰äº†ä¸€ä¸ªåä¸º printHello çš„å‡½æ•°ã€‚ æ‰§è¡Œåˆ°ç¬¬äºŒè¡Œæ—¶, JS åšçš„æ˜¯è°ƒç”¨ä¸€ä¸‹æµè§ˆå™¨é‡Œçš„å®šæ—¶å™¨åŠŸèƒ½, è°ƒç”¨åä¸éœ€è¦ç­‰åˆ° 1000ms ç»“æŸ, JS å·²ç»å®Œæˆäº†å‘¼å«æµè§ˆå™¨å¸®å¿™è®¡æ—¶çš„ä»»åŠ¡, ç›´æ¥å»å¾€ä¸‹ä¸€è¡Œäº†ã€‚è¿™é‡Œæµè§ˆå™¨é‡Œçš„ printHello æ˜¯ä¸€ä¸ªå¼•ç”¨, è€Œä¸æ˜¯å¤åˆ¶äº†ä¸€ä»½ä»£ç ã€‚ä¸æ­¤åŒæ—¶, æµè§ˆå™¨çš„å®šæ—¶å™¨å¼€å§‹è®¡æ—¶, çœ‹æ˜¯å¦åˆ°äº† 1000ms, è¿™å’Œ JS ä»£ç æ‰§è¡Œæ˜¯åˆ†å¼€ç‹¬ç«‹çš„ã€‚ JSç»§ç»­æ‰§è¡Œç¬¬ä¸‰è¡Œ, åœ¨ console é‡Œæ‰“å° â€œMe first!â€, æ­¤æ—¶å¸¸è§„çš„ JS ä»£ç å·²ç»æ‰§è¡Œå®Œæˆ, æ—¶é—´å¯èƒ½è¿‡å»äº† 1ms è¿˜ä¸åˆ°ã€‚ä½†æ˜¯æµè§ˆå™¨ä»åœ¨åœ¨åå°â€œæ»´æ»´ç­”ç­”â€åœ°æ‰§è¡Œè®¡æ—¶ã€‚ åˆ°äº† 1000ms æ—¶, è®¡æ—¶ç»“æŸ, printHello è°ƒå¤´å›åˆ° JS çš„æ‰§è¡Œç¯å¢ƒ, å¹¶è¢«æ”¾å› JS çš„Callback Queue å›è°ƒé˜Ÿåˆ—ä¸­, è¿™ä¸ªé˜Ÿåˆ—å¹¶ä¸åšæ‰§è¡Œçš„å·¥ä½œ, å’Œ Call Stack ä¹Ÿæ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚ç”±äºæ­¤æ—¶ global ä¸­çš„ä»£ç ä¹Ÿéƒ½æ‰§è¡Œå®Œäº†(ä¹Ÿå°±æ˜¯æ‰€æœ‰ JS ä»£ç éƒ½æŒ‰é¡ºåºæ‰§è¡Œå®Œäº†), printHello ä» Callback Queue å‡ºé˜Ÿ, è¿›å…¥ JS å‡½æ•°è°ƒç”¨æ ˆ, æ‰§è¡Œã€‚ ç¤ºä¾‹å’Œè¯´æ˜2ç»§ç»­çœ‹ä¸€ä¸ªä¾‹å­ã€‚ç°åœ¨æŠŠä¸Šé¢çš„å®šæ—¶å™¨æ—¶é—´æ”¹ä¸º 0ms, å¹¶å¢åŠ ä¸€ä¸ªå¸¸è§„çš„ JS å‡½æ•°, å¹¶å‡è®¾è¿™ä¸ªå‡½æ•°éœ€è¦ 1s çš„æ‰§è¡Œæ—¶é—´ã€‚ 12345678function printHello(){ console.log(&quot;Hello&quot;) }function blockFor1Sec(){ // å‡è®¾è¿™ä¸ªå‡½æ•°æ‰§è¡Œéœ€è¦ 1000ms }setTimeout(printHello,0)blockFor1Sec()console.log(&quot;Me first!&quot;) æ‰“å°å‡ºæ¥çš„é¡ºåºå¦‚ä¸‹, è™½ç„¶å®šæ—¶å™¨è®¾ç½®çš„æ˜¯ 0s, ä»åœ¨æœ€åæ‰“å°å‡ºæ¥ è¿™æ˜¯å› ä¸ºå³ä½¿è®¡æ—¶æ—¶é—´æ˜¯ 0ms, 0msç»“æŸæ—¶, printHello è¿›å…¥çš„æ˜¯ Callback Queue, JS ä¼šä¼˜å…ˆæ‰§è¡Œå®Œ Call Stack ä¸­çš„å‡½æ•°, å†å°† Callback Queue ä¸­çš„å‡½æ•°æŒªåˆ° Call Stack ä¸­æ‰§è¡Œã€‚ ä¸‹é¢æ¥çœ‹å…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹, ä»å‡½æ•°å®šä¹‰åè°ƒç”¨ setTimeout å¼€å§‹0ms è°ƒç”¨ setTimeout, æµè§ˆå™¨è®¡æ—¶, è®¡æ—¶ç»“æŸå printHello å…ˆè¿›å…¥ Callback Queueç­‰å¾…ã€‚ 1ms JS æ‰§è¡Œè°ƒç”¨æ ˆæœ€åº•ä¸‹çš„ global(), æ‰§è¡Œä¸‹ä¸€è¡Œ, è°ƒç”¨ blockFor1Secã€‚ 1001ms æ‰§è¡Œ blockFor1Sec ç”¨äº† 1s, è¿™æ—¶å€™æ‰§è¡Œ global() çš„ä»£ç , åˆ°ä¸‹ä¸€è¡Œè°ƒç”¨ console.log(â€˜Me First!â€™)ã€‚printHello ä»ç„¶åœ¨å›è°ƒé˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚ 1002ms global ä¸­æ‰€æœ‰çš„ä»£ç éƒ½æ‰§è¡Œå®Œäº†, printHello ä»å›è°ƒé˜Ÿåˆ—ä¸­å‡ºé˜Ÿ, å‹å…¥è°ƒç”¨æ ˆã€‚ è§„åˆ™æ€»ç»“å°†å‡½æ•°ä» Callback Queue ä¸­ç§»å…¥è°ƒç”¨æ ˆä¸­çš„æ—¶æœºæ˜¯æ‰€æœ‰çš„åŒæ­¥ä»£ç éƒ½æ‰§è¡Œå®Œæ¯•åã€‚åº”ç”¨è¿™ä¸ªè§„åˆ™, å°±å¯ä»¥ç¡®å®šå‡½æ•°æ‰§è¡Œçš„é¡ºåºã€‚ event loopé‚£ä¹ˆ JS æ˜¯å¦‚ä½•çŸ¥é“å¯ä»¥æ‰§è¡Œ callback ä¸­çš„å†…å®¹çš„å‘¢, è¿™å°±æ¶‰åŠäº†å…³é”®çš„ event loop æœºåˆ¶ã€‚event loop åœ¨æ¯ä¸€è¡Œä»£ç æ‰§è¡Œå‰, éƒ½ä¼šä¸åœæ£€æŸ¥: 1.Call Stack ä¸­çš„å‡½æ•°æ˜¯å¦å…¨éƒ¨æ‰§è¡Œå®Œäº†, ä¹ŸåŒ…æ‹¬è°ƒç”¨æ ˆæœ€åº•ä¸‹å…¨å±€ç¯å¢ƒä¸‹çš„ä»£ç æ˜¯å¦æ‰§è¡Œå®Œäº†ã€‚ 2.Callback Queue ä¸­æ˜¯å¦æœ‰å¾…æ‰§è¡Œå‡½æ•°ã€‚ 3.å½“ Call Stack ä¸­æ‰€æœ‰çš„ä»£ç éƒ½æ‰§è¡Œå®Œ, å°±ä¼šå» Callback Queue ä¸­æŠŠå‡½æ•°ç§»å…¥ Call Stack ä¸­æ‰§è¡Œã€‚ Promises å’Œ Microtask QueuePromise å¯¹è±¡ä»¥ fetch ä¸ºä¾‹, æ‰§è¡Œ fetch ä¼šåŒæ—¶åšä¸¤ä»¶äº‹, ä¸€æ˜¯åœ¨ JS ä¸­è¿”å›ä¸€ä¸ª Promise å¯¹è±¡, å¦ä¸€æ–¹é¢, åœ¨æµè§ˆå™¨ä¸­, ä¼šè§¦å‘æµè§ˆå™¨æ¥è¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚ å…¶è¿”å›çš„ Promise å¯¹è±¡çš„å±æ€§å¦‚ä¸‹, è¿™äº›å±æ€§éƒ½ä¸èƒ½ä½¿ç”¨ç‚¹è¯­æ³•å–å¾—: 1.value: é»˜è®¤å€¼æ˜¯ null, å½“æµè§ˆå™¨è¯·æ±‚çš„æ•°æ®è¿”å›äº†, global ä»£ç æ‰§è¡Œå®Œæˆå, ä¼šç«‹åˆ»è‡ªåŠ¨æ›´æ–° value çš„å€¼ã€‚ 2.onFulfilledï¼š é»˜è®¤æ˜¯ç©ºæ•°ç»„, .then() ä¸­è¦æ‰§è¡Œçš„å‡½æ•°ä¼š push åˆ°è¿™ä¸ªæ•°ç»„ä¸­ã€‚å½“ç½‘ç»œè¯·æ±‚è¿”å›äº†æ•°æ®, value çš„å€¼æ›´æ–°å, æ•°ç»„ä¸­çš„å‡½æ•°ä¼šè¿›å…¥ Microtask Queue å¾®ä»»åŠ¡é˜Ÿåˆ—, ç­‰å¾…æ‰§è¡Œã€‚ 3.onRejection: é»˜è®¤æ˜¯ä¸€ä¸ªç©ºæ•°ç»„ã€‚.catch() ä¸­è¦æ‰§è¡Œçš„å‡½æ•°ä¼š push åˆ°è¿™ä¸ªæ•°ç»„ä¸­ã€‚ ä¼šè¿”å› Promise å¯¹è±¡çš„å†…ç½®å‡½æ•°å¯ä»¥åœ¨ MDN ä¸ŠæŸ¥åˆ°ã€‚ Microtask QueuePromise å¯¹è±¡ .then() æ–¹æ³•ä¸­çš„å›è°ƒå‡½æ•°åœ¨è¿”å›å€¼æ›´æ–°åä¼šè¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—, å®ƒå’Œå‰é¢è¯´çš„å›è°ƒé˜Ÿåˆ—æ˜¯ç‹¬ç«‹çš„, å¹¶ä¸”é‡Œé¢çš„å‡½æ•°æ‰§è¡Œä¼˜å…ˆçº§é«˜äºå›è°ƒé˜Ÿåˆ—ã€‚å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å‡½æ•°åŒæ ·æ˜¯å…ˆè¿›å…ˆå‡ºã€‚ æ‰§è¡Œè¿‡ç¨‹ç¤ºä¾‹ç¤ºä¾‹ä»£ç 12345678910111213141516function display(data){console.log(data)}function printHello(){console.log(\"Hello\")}function blockFor300ms(){ // å‡è®¾è¿™ä¸ªå‡½æ•°æ‰§è¡Œéœ€è¦ 300ms }setTimeout(printHello, 0)const futureData = fetch('https://twitter.com/will/tweets/1')futureData.then(display)blockFor300ms()console.log(\"Me first!\")// è¾“å‡ºé¡ºåº// Me first!// data çš„å€¼// Hello æ‰§è¡Œè¿‡ç¨‹ä»3ä¸ªå‡½æ•°å®šä¹‰åå¼€å§‹, ä¸Šè¿°ä»£ç æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹: 0ms è§¦å‘æµè§ˆå™¨çš„å®šæ—¶å™¨åŠŸèƒ½è®¡æ—¶ 0 ms, 0ms è®¡æ—¶å®Œæˆ, printHello è¿›å…¥ Callback é˜Ÿåˆ— 1ms æ‰§è¡Œ fetch(), è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ç»™ futureData æ ‡ç­¾, åŒæ—¶å‘Šè¯‰æµè§ˆå™¨è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼ˆåŒ…æ‹¬ ä¸»æœºåã€åœ°å€ã€æ–¹æ³•è¿™äº›ä¿¡æ¯ï¼‰ æ‰§è¡Œ fetchData.then(display), å°† display æ–¹æ³•å­˜å…¥ Promise å¯¹è±¡ onFulfilled å±æ€§å¯¹åº”çš„æ•°ç»„ä¸­ 2ms æ‰§è¡Œ blockFor300ms, è¿™ä¸ªç¨‹åºæ‰§è¡Œè¦ 300ms, è¿™æ˜¯åŒæ­¥ä»£ç æ‰€ä»¥ JS ä¼šåœ¨ 300ms åå†æ‰§è¡Œä¸‹ä¸€è¡Œ 270ms å‡è®¾æ­¤æ—¶å¼‚æ­¥è¯·æ±‚çš„æ•°æ®è¿”å›äº†, Promise å¯¹è±¡ futureData çš„ value å±æ€§å€¼ä¼šæ›´æ–°ä¸ºè¯·æ±‚å›æ¥çš„æ•°æ®ã€‚åŒæ—¶è‡ªåŠ¨å°† Promise å¯¹è±¡ onFulfilled æ•°ç»„ä¸­çš„å‡½æ•°, æ³¨å†Œè¿› Microtask Queueã€‚ 302ms blockFor300ms æ‰§è¡Œå®Œäº†, global ä¸­è¿˜æœ‰ä»£ç , æ‰€ä»¥ç»§ç»­æ‰§è¡Œä¸‹ä¸€è¡Œ console.log(â€œMe firstâ€), ä¼šç›´æ¥åœ¨ console è¾“å‡ºå†…å®¹ã€‚ 303ms æ•´ä¸ªè¿‡ç¨‹ä¸­ eventloop ä¸€ç›´åœ¨è¿›è¡Œæ£€æµ‹, æ­¤æ—¶è°ƒç”¨æ ˆä¸­æ²¡æœ‰å‡½æ•°åœ¨æ‰§è¡Œ, global ä¸­çš„ä»£ç ä¹Ÿæ‰§è¡Œå®Œäº†; Microtask Queue å’Œ Callback Queue ä¸­éƒ½æœ‰å¾…æ‰§è¡Œçš„å‡½æ•°, ä¼˜å…ˆå°† Microtask Queue ä¸­çš„å‡½æ•°â€œç§»å…¥â€è°ƒç”¨æ ˆã€‚åœ¨ console æ‰“å°å‡º data çš„å€¼ã€‚ 304ms è°ƒç”¨æ ˆ å’Œ Microtask Queue éƒ½ç©ºäº†, å°† Callback Queue ä¸­çš„ printHello â€œç§»å…¥â€è°ƒç”¨æ ˆä¸­æ‰§è¡Œã€‚åœ¨ console é¢æ¿ä¸­è¾“å‡º â€œHelloâ€ã€‚ æ€»ç»“åˆ†ç±»1.å¸¸è§„çš„åŒæ­¥ä»£ç å‡½æ•°è°ƒç”¨éƒ½ä¼šç›´æ¥è¿›å…¥ Call Stack è°ƒç”¨æ ˆä¸­, ä»¥æœ€é«˜ä¼˜å…ˆçº§è°ƒç”¨ 2.è€çš„å›è°ƒ Api, å¦‚ setTimeout, å…¶å›è°ƒå‡½æ•°ä¼šè¿›å…¥ Callback Queue ä¸­ 3.æ‰€æœ‰é€šè¿‡ then æ–¹æ³•é™„å±äºæŸä¸ª Promise å¯¹è±¡çš„å‡½æ•°, å½“ Promise å¯¹è±¡ value å±æ€§çš„å€¼è‡ªåŠ¨æ›´æ–°æ—¶, è¿›å…¥ Microtask Queue ä¸­ æ‰§è¡Œé¡ºåº0.ä¼˜å…ˆæ‰§è¡Œå®Œ Call Stack ä¸­çš„å‡½æ•°, å’Œ global ä¸­çš„ä»£ç , ç›´åˆ°æ‰€æœ‰ä»£ç éƒ½æ‰§è¡Œå®Œ 1.å…¶æ¬¡å°† Microtask Queue ä¸­çš„å‡½æ•°ç§»å…¥ Call Stack ä¸­æ‰§è¡Œ 2.æœ€åå°† Callback Queue ä¸­çš„å‡½æ•°ç§»å…¥ Call Stack ä¸­æ‰§è¡Œ å­¦ä¹ èµ„æ–™è§†é¢‘ï¼š JavaScript: The Hard Parts, v2","link":"/2020/01/29/å¼‚æ­¥å’ŒPromiseæ‰§è¡Œè¿‡ç¨‹å›¾è§£/"}],"tags":[],"categories":[{"name":"JavaScript","slug":"JavaScript","link":"/categories/JavaScript/"}]}